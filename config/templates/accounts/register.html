{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}ثبت‌نام - Abol Store{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
    <h1 class="text-2xl font-bold text-secondary mb-6 text-center">ثبت‌نام در Abol Store</h1>
    
    <form id="register-form" method="post" class="space-y-4">
        {% csrf_token %}
        {{ form|crispy }}
        
        <div id="register-errors" class="text-red-600 text-sm space-y-1"></div>
        
        <div class="flex justify-between items-center mt-6">
            <button id="register-submit" type="submit" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition flex items-center gap-2">
                <span>ثبت‌نام</span>
                <span id="register-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
            </button>
            <a href="{% url 'accounts:login' %}" class="text-secondary hover:underline">قبلاً ثبت‌نام کرده‌اید؟</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// اعتبارسنجی سمت‌کلاینت برای ثبت‌نام
const form = document.getElementById('register-form');
const errorsBox = document.getElementById('register-errors');
const submitBtn = document.getElementById('register-submit');
const spinner = document.getElementById('register-spinner');

function isValidIranPhone(phone) {
    return /^0?9\d{9}$/.test(phone);
}
function isValidTelegramId(id) {
    return /^@?[A-Za-z0-9_]{5,32}$/.test(id);
}

form.addEventListener('submit', function(e) {
    errorsBox.innerHTML = '';
    const usernameInput = form.querySelector('input[name="username"]');
    const phoneInput = form.querySelector('input[name="phone_number"]');
    const telegramInput = form.querySelector('input[name="telegram_id"]');
    const password1Input = form.querySelector('input[name="password1"]');
    const password2Input = form.querySelector('input[name="password2"]');
    
    let hasError = false;
    if (usernameInput && usernameInput.value.trim().length === 0) {
        errorsBox.insertAdjacentHTML('beforeend', '<div>نام کاربری را وارد کنید.</div>');
        hasError = true;
    }
    if (phoneInput && phoneInput.value && !isValidIranPhone(phoneInput.value)) {
        errorsBox.insertAdjacentHTML('beforeend', '<div>شماره موبایل نامعتبر است. مثال: 09123456789</div>');
        hasError = true;
    }
    if (telegramInput && telegramInput.value && !isValidTelegramId(telegramInput.value)) {
        errorsBox.insertAdjacentHTML('beforeend', '<div>آیدی تلگرام نامعتبر است. مثال: @test_user</div>');
        hasError = true;
    }
    if (password1Input && password1Input.value.length < 8) {
        errorsBox.insertAdjacentHTML('beforeend', '<div>رمز عبور باید حداقل ۸ کاراکتر باشد.</div>');
        hasError = true;
    }
    if (password2Input && password1Input && password2Input.value !== password1Input.value) {
        errorsBox.insertAdjacentHTML('beforeend', '<div>رمزهای عبور با هم برابر نیستند.</div>');
        hasError = true;
    }
    
    if (hasError) {
        e.preventDefault();
        return;
    }
    // نمایش اسپینر
    spinner.classList.remove('hidden');
    submitBtn.setAttribute('disabled', 'disabled');
});
</script>
{% endblock %}